<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Murray">
<meta name="dcterms.date" content="2024-07-02">

<title>Home - Matrix calculus: tips tricks and useful identities</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching.html" rel="" target="">
 <span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Matrix calculus: tips tricks and useful identities</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Matrices</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Michael Murray </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 2, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-a-matrix-derivative-and-why-is-it-useful" id="toc-what-is-a-matrix-derivative-and-why-is-it-useful" class="nav-link active" data-scroll-target="#what-is-a-matrix-derivative-and-why-is-it-useful">What is a matrix derivative and why is it useful?</a></li>
  <li><a href="#categories-of-matrix-derivative" id="toc-categories-of-matrix-derivative" class="nav-link" data-scroll-target="#categories-of-matrix-derivative">Categories of matrix derivative</a></li>
  <li><a href="#useful-identities-vector-derivatives-of-a-vector" id="toc-useful-identities-vector-derivatives-of-a-vector" class="nav-link" data-scroll-target="#useful-identities-vector-derivatives-of-a-vector">Useful identities: vector derivatives of a vector</a>
  <ul class="collapse">
  <li><a href="#linear-systems-of-equations" id="toc-linear-systems-of-equations" class="nav-link" data-scroll-target="#linear-systems-of-equations">Linear systems of equations</a></li>
  <li><a href="#the-chain-rule-for-vector-valued-functions-of-multiple-variables" id="toc-the-chain-rule-for-vector-valued-functions-of-multiple-variables" class="nav-link" data-scroll-target="#the-chain-rule-for-vector-valued-functions-of-multiple-variables">The chain rule for vector valued functions of multiple variables</a></li>
  </ul></li>
  <li><a href="#useful-identities-matrix-derivatives-of-a-scalar" id="toc-useful-identities-matrix-derivatives-of-a-scalar" class="nav-link" data-scroll-target="#useful-identities-matrix-derivatives-of-a-scalar">Useful identities: matrix derivatives of a scalar</a>
  <ul class="collapse">
  <li><a href="#matrix-derivatives-of-bilinear-forms" id="toc-matrix-derivatives-of-bilinear-forms" class="nav-link" data-scroll-target="#matrix-derivatives-of-bilinear-forms">Matrix derivatives of bilinear forms</a></li>
  <li><a href="#matrix-derivatives-of-norms" id="toc-matrix-derivatives-of-norms" class="nav-link" data-scroll-target="#matrix-derivatives-of-norms">Matrix derivatives of norms</a></li>
  <li><a href="#matrix-derivatives-of-the-trace." id="toc-matrix-derivatives-of-the-trace." class="nav-link" data-scroll-target="#matrix-derivatives-of-the-trace.">Matrix derivatives of the Trace.</a></li>
  <li><a href="#matrix-derivarives-of-determinants" id="toc-matrix-derivarives-of-determinants" class="nav-link" data-scroll-target="#matrix-derivarives-of-determinants">Matrix derivarives of determinants</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p><em>An overview and derivation of some basic rules and applications of matrix calculus.</em></p>
<div class="hidden">
%%%%% NEW MATH DEFINITIONS %%%%% $$ %
{lemma}{Lemma}
<p>{}[1]{{#1}} </p>
<p>% Figure reference, lower-case. % Figure reference, capital. For start of sentence % Section reference, lower-case. % Section reference, capital. % Reference to two sections. % Reference to three sections. % Reference to an equation, lower-case. % Reference to an equation, upper case % A raw reference to an equation—avoid using if possible % Reference to a chapter, lower-case. % Reference to an equation, upper case. % Reference to a range of chapters % Reference to an algorithm, lower-case. % Reference to an algorithm, upper case. % Reference to a part, lower case % Reference to a part, upper case </p>
<p>% Random variables % rm is already a command, just don’t name any random variables m </p>
<p>% Random vectors </p>
<p>% Elements of random vectors </p>
<p>% Random matrices </p>
<p>% Elements of random matrices </p>
<p>% Vectors </p>
<p>% Elements of vectors </p>
<p>% Matrix </p>
% Tensor
<p>% </p>
<p>% Graph </p>
<p>% Sets % Don’t use a set called E, because this would be the same as our symbol % for expectation. </p>
<p>% Entries of a matrix </p>
% entries of a tensor % Same font as tensor, without wrapper
<p>% The true underlying data generating distribution % The empirical distribution defined by the training set % The model distribution % Stochastic autoencoder distributions </p>
<p>% Laplace distribution</p>
<p>% Wolfram Mathworld says <span class="math inline">\(L^2\)</span> is for function spaces and <span class="math inline">\(\ell^2\)</span> is for vectors % But then they seem to use <span class="math inline">\(L^2\)</span> for vectors throughout the site, and so does % wikipedia. </p>
<p>% See usage in notation.tex. Chosen to match Daphne’s book.</p>
% MM commands % Defined commands
<p>% </p>
<p>% Caligraphic letters $$</p>
</div>
<p><strong>Matrix calculus is system of notation along with a set of identities which can prove useful for organizing and manipulating expressions involving the partial derivatives of functions.</strong> A key benefit of matrix calculus is that it allows us to to collect together partial derivatives into vectors and matrices so that they can be treated as unified object. Note we will not discuss here functional derivatives such as the Frechet derivative or other generalizations like the Gateaux derivative. As long as you are familiar with a plain old partial derivative I hope the rest of this post will be easy to follow! We will exclusively be looking at real valued scalars, vectors and matrices. Furthermore with regards to notation wise we will use both <span class="math inline">\([A]_{ij}\)</span> and <span class="math inline">\(a_{ij}\)</span> to refer to the entry of the matrix <span class="math inline">\(A\)</span> on row <span class="math inline">\(i\)</span> and column <span class="math inline">\(j\)</span>, whichever is more convenient.</p>
<section id="what-is-a-matrix-derivative-and-why-is-it-useful" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-matrix-derivative-and-why-is-it-useful">What is a matrix derivative and why is it useful?</h2>
<p>In optimization, and indeed many other areas of applied maths, one often has to work with functions of multiple variables and their derivatives with respect to these variables. Organizing these partial derivatives sensibly can save a lot of time and effort and often collecting them into matrices or vectors can make sense. For example, if we have <span class="math inline">\(m\)</span> functions which each depend on the same set of <span class="math inline">\(n\)</span> variables, then these partial derivatives can be organized by placing them in an <span class="math inline">\(m \times n\)</span> matrix, where each row contains the partial derivatives of one of the functions with respect to each variable. Beyond organizing partial derivatives into matrices and vectors we can also identify identities for taking matrix and vector derivatives. For example, suppose <span class="math inline">\(A \in \mathbb{R}^{m \times n}\)</span>, <span class="math inline">\(x \in \mathbb{R}^n\)</span> and <span class="math display">\[
y = Ax.
\]</span> Suppose we want to compute the partial derivatives of <span class="math inline">\(y\)</span> with respect to the entries <span class="math inline">\(x\)</span>. Clearly <span class="math inline">\(\frac{\partial y_i}{\partial x_j} = a_{ij}\)</span>, we can therefore organize these partial derivatives into a matrix we denote <span class="math inline">\(\frac{\partial y}{\partial x} \in \mathbb{R}^{m \times n}\)</span> where <span class="math inline">\([\frac{\partial y}{\partial x}]_{ij} = a_{ij}\)</span>. Alternatively we can write this as <span class="math display">\[
\frac{\partial y}{\partial x} = \frac{\partial}{\partial x} Ax = A
\]</span> which agrees very nicely with our intuition!Note however that there isn’t really always a nice way of organizing the partial derivatives of <span class="math inline">\(y\)</span> with respect to the entries of <span class="math inline">\(A\)</span> as <span class="math inline">\(\frac{\partial y_i}{\partial a_{jk}} = x_k\)</span> if <span class="math inline">\(j = i\)</span> and <span class="math inline">\(\frac{\partial y_i}{\partial a_{jk}} = 0\)</span> otherwise and we can’t organize this into a matrix whose dimensions are in some sense consistent with the dimensions of either <span class="math inline">\(y\)</span> or <span class="math inline">\(A\)</span>. In the rest of this note we first provide an overview of the useful categories of matrix derivative and their definitions, and then proceed to prove certain useful identities illustrating the usefullness of the notation.</p>
</section>
<section id="categories-of-matrix-derivative" class="level2">
<h2 class="anchored" data-anchor-id="categories-of-matrix-derivative">Categories of matrix derivative</h2>
<p>In matrix calculus we organize partial derivatives into matrices in the broad sense: note we can interpret a vector as as a restricted type of matrix with only one row or column, and scalars also as a restricted type of matrix consisting of just a single entry. Given two matrices <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> then we want to define the matrix derivative <span class="math inline">\(\frac{\partial X}{\partial Y}\)</span> in such a way that the dimensions which are in some sense consistent with <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>: for instance, in the example above recall the matrix derivative was a vector which matched the dimensions of <span class="math inline">\(y\)</span>. Indeed, without some notion of consistency in the dimensions then deriving versions of common, useful identities becomes messy and without these identities the appeal of using the matrix calculus notation is lost. Definitions of matrix derivatives in matrix calculus therefore focus on the following two categories.</p>
<ul>
<li><p><strong>Matrix-scalar</strong> derivatives: here we take the partial derivatives of a scalar with respect to a the elements of a matrix or take the partial derivative of the elements of a matrix with respect to a scalar and form a matrix.</p></li>
<li><p><strong>Vector-vector</strong> derivatives: here we take the partial derivatives of the elements of one vector with respect to the elements of another and form a matrix.</p></li>
</ul>
<section id="matrix-scalar-derivatives" class="level4">
<h4 class="anchored" data-anchor-id="matrix-scalar-derivatives">Matrix-scalar derivatives</h4>
<p>Given a scalar <span class="math inline">\(y \in \mathbb{R}\)</span> and the matrix <span class="math inline">\(X \in \mathbb{R}^{m \times n}\)</span>, we define the matrix <span class="math inline">\(\frac{\partial y}{ \partial X} \in \mathbb{R}^{m \times n}\)</span> as <span class="math display">\[
\frac{\partial X}{ \partial y} = \begin{bmatrix}
\frac{\partial x_{11}}{\partial y} &amp; \frac{\partial x_{12}}{\partial y} &amp; \cdots &amp; \frac{\partial x_{1n}}{\partial y}\\
\frac{\partial x_{21}}{\partial y} &amp; \frac{\partial x_{22}}{\partial y} &amp; \cdots &amp; \frac{\partial x_{2n}}{\partial y}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
\frac{\partial x_{m1}}{\partial y} &amp; \frac{\partial x_{m2}}{\partial y} &amp; \cdots &amp; \frac{\partial x_{mn}}{\partial y}
\end{bmatrix}
\]</span> as the matrix derivative of <span class="math inline">\(y\)</span> with respect to <span class="math inline">\(m\)</span>. Likewise we define the matrix derivative of <span class="math inline">\(X\)</span> with respect to <span class="math inline">\(y\)</span> denoted <span class="math inline">\(\frac{\partial X}{ \partial y} \in \mathbb{R}^{m \times n}\)</span> as <span class="math display">\[
\frac{\partial y}{ \partial X} = \begin{bmatrix}
\frac{\partial y}{\partial x_{11}} &amp; \frac{\partial y}{\partial x_{12}} &amp; \cdots &amp; \frac{\partial y}{\partial x_{1n}}\\
\frac{\partial y}{\partial x_{21}} &amp; \frac{\partial y}{\partial x_{22}} &amp; \cdots &amp; \frac{\partial y}{\partial x_{2n}}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
\frac{\partial y}{\partial x_{m1}} &amp; \frac{\partial y}{\partial x_{m2}}&amp; \cdots &amp; \frac{\partial y}{\partial x_{mn}}
\end{bmatrix}
\]</span> Note this also includes vector-scalar derivatives by considering a vector as a matrix with a single column! It is worth noting that sometimes the vector-vector derivative is defined as the transpose of the above, as long as you are consistent however it does not really matter.</p>
</section>
<section id="vector-vector-derivatives" class="level4">
<h4 class="anchored" data-anchor-id="vector-vector-derivatives">Vector-vector derivatives</h4>
<p>Given two vectors <span class="math inline">\(y \in \mathbb{R}^m\)</span> and the matrix <span class="math inline">\(x \in \mathbb{R}^{n}\)</span>, we define the matrix <span class="math inline">\(\frac{\partial y}{ \partial X} \in \mathbb{R}^{m \times n}\)</span> as <span class="math display">\[
\frac{\partial y}{ \partial x} = \begin{bmatrix}
\frac{\partial y_1}{\partial x_{1}} &amp; \frac{\partial y_1}{\partial x_{2}} &amp; \cdots &amp; \frac{\partial y_1}{\partial x_{n}}\\
\frac{\partial y_2}{\partial x_{1}} &amp; \frac{\partial y_2}{\partial x_{2}} &amp; \cdots &amp; \frac{\partial y_2}{\partial x_{n}}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
\frac{\partial y_m}{\partial x_{1}} &amp; \frac{\partial y_m}{\partial x_{2}}&amp; \cdots &amp; \frac{\partial y_m}{\partial x_{n}}
\end{bmatrix}
\]</span></p>
</section>
<section id="point-on-notation" class="level4">
<h4 class="anchored" data-anchor-id="point-on-notation">Point on notation</h4>
<p>So far given two matrices <span class="math inline">\(X\)</span>, <span class="math inline">\(Y\)</span> we denoted the matrix derivative of <span class="math inline">\(X\)</span> with respect to <span class="math inline">\(Y\)</span> as <span class="math inline">\(\frac{\partial X}{\partial Y}\)</span>. In what follows for convenience we will also equally use <span class="math inline">\(\partial_Y X\)</span> to denote the same thing.</p>
</section>
</section>
<section id="useful-identities-vector-derivatives-of-a-vector" class="level2">
<h2 class="anchored" data-anchor-id="useful-identities-vector-derivatives-of-a-vector">Useful identities: vector derivatives of a vector</h2>
<section id="linear-systems-of-equations" class="level3">
<h3 class="anchored" data-anchor-id="linear-systems-of-equations">Linear systems of equations</h3>
<p>Lets start easy, we have already seen the following nice and intuitive identity: if <span class="math inline">\(y = Ax\)</span> then <span class="math inline">\(\partial_x y = A\)</span>. As a slightly more complicated consider a function $ f: ^d ^n$</p>
<p><span class="math display">\[
f(x) =  \begin{bmatrix}
f_1(x_1, x_2, ... x_d) \\
\vdots\\
f_d(x_1, x_2, ... x_d)
\end{bmatrix}
\]</span></p>
<p>where we assume all partial derivatives of <span class="math inline">\(f_i\)</span> for <span class="math inline">\(i \in [n]\)</span> exist with respect to <span class="math inline">\(x_j\)</span> for all <span class="math inline">\(j \in[m]\)</span>.</p>
<div id="prp-lin-sys" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 1 </strong></span>Suppose <span class="math inline">\(A \in \mathbb{R}^{m \times n }\)</span> and <span class="math inline">\(x \in \mathbb{R}^n\)</span>. If <span class="math inline">\(y = Af(x)\)</span> then <span class="math display">\[
\frac{\partial y}{\partial x} = A \frac{\partial f}{\partial x}
\]</span></p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span>Taking the partial derivative <span class="math inline">\(r \in [n]\)</span>, <span class="math inline">\(c \in [d]\)</span> then <span class="math display">\[
\left[\frac{\partial y}{\partial x}  \right]_{rc} = \frac{\partial y_r}{\partial x_{c}} = \sum_{} a_{i,l}\frac{\partial}{\partial x_{c}} [f(x)]_l
\]</span> Therefore by definition <span class="math inline">\(\frac{\partial}{\partial A} = 2A\)</span>.</p>
</div>
</section>
<section id="the-chain-rule-for-vector-valued-functions-of-multiple-variables" class="level3">
<h3 class="anchored" data-anchor-id="the-chain-rule-for-vector-valued-functions-of-multiple-variables">The chain rule for vector valued functions of multiple variables</h3>
<p>XXX</p>
</section>
</section>
<section id="useful-identities-matrix-derivatives-of-a-scalar" class="level2">
<h2 class="anchored" data-anchor-id="useful-identities-matrix-derivatives-of-a-scalar">Useful identities: matrix derivatives of a scalar</h2>
<section id="matrix-derivatives-of-bilinear-forms" class="level3">
<h3 class="anchored" data-anchor-id="matrix-derivatives-of-bilinear-forms">Matrix derivatives of bilinear forms</h3>
<p>XXX</p>
</section>
<section id="matrix-derivatives-of-norms" class="level3">
<h3 class="anchored" data-anchor-id="matrix-derivatives-of-norms">Matrix derivatives of norms</h3>
<p>Analogous to the fact that <span class="math inline">\(\frac{d}{dx}x^2 = 2x\)</span> we have the following.</p>
<div id="prp-frob" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 2 </strong></span>For a matrix <span class="math inline">\(A \in \mathbb{R}^{n \times m}\)</span> then <span class="math display">\[
\frac{\partial}{\partial A}|| A||_F^2 = 2A.
\]</span></p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span>Taking the partial derivative with respect to a single element of the matrix <span class="math display">\[
\left[\frac{\partial}{\partial A}|| A||_F^2 \right]_{rc} = \frac{\partial}{\partial a_{rc}}|| A||_F^2 = \frac{\partial}{\partial a_{rc}} \sum_{i=1}^{m} \sum_{j=1}^{n} a_{ij}^2 = 2 a_{rc} = 2[A]_{rc}
\]</span> Therefore by definition <span class="math inline">\(\frac{\partial}{\partial A} = 2A\)</span>.</p>
</div>
</section>
<section id="matrix-derivatives-of-the-trace." class="level3">
<h3 class="anchored" data-anchor-id="matrix-derivatives-of-the-trace.">Matrix derivatives of the Trace.</h3>
<p>Taking the matrix derivative of a Trace of a product of matrices is very common if one is working with say the Frobenius norm. Recall that the <span class="math inline">\(\mathop{\mathrm{Tr}}: \mathbb{R}^{d_1 \times d_1} \rightarrow \mathbb{R}\)</span> is defined as the sum of the diagonal entries, <span class="math display">\[
\mathop{\mathrm{Tr}}(A) = \sum_{i = 1}^{d_1} a_{ii}.
\]</span> By definition of the Trace the following rules are immediatly apparent for any square matrices <span class="math inline">\(A,B\)</span> of the same dimension.</p>
<ul>
<li><p><span class="math inline">\(Tr(A) = \mathop{\mathrm{Tr}}(A^T)\)</span>,</p></li>
<li><p><span class="math inline">\(\mathop{\mathrm{Tr}}(A + B) = \mathop{\mathrm{Tr}}(A) + \mathop{\mathrm{Tr}}(B)\)</span>,</p></li>
</ul>
<p>The Trace and Frobenius norm are also connected, indeed <span class="math display">\[
\begin{aligned}
\mathop{\mathrm{Tr}}(A^T A) &amp;= \sum_{i}^{d_2}[A^TA]_{ii} = \sum_{i}^{d_2} \left( \sum_{j}^{d_1} a_{ji} a_{ji} \right)
= \sum_{j}^{d_1}\sum_{i}^{d_2} a_{ji}^2
= ||A||_F^2.
\end{aligned}
\]</span> Therefore from <a href="#prp-frob">Proposition&nbsp;2</a> we know that <span class="math inline">\(\partial_A \mathop{\mathrm{Tr}}(A^TA) = 2A\)</span>. To motivate the particular Trace functions we study the matrix derivative of consider a least squares objective: given <span class="math inline">\(W \in \mathbb{R}^{d_2 \times d_1}\)</span>, <span class="math inline">\(X \in \mathbb{R}^{d_1 \times n}\)</span>, <span class="math inline">\(Y \in \mathbb{R}^{d_2 \times n}\)</span>. Then the function <span class="math display">\[
L(W) = || Y - WX ||_F^2
\]</span> can be interpreted as summing the least squares error between <span class="math inline">\(W X_{:,i}\)</span> and <span class="math inline">\(Y_{:, i}\)</span> for all <span class="math inline">\(i \in [n]\)</span>. Here we could think then of <span class="math inline">\(n\)</span> as the number of points in the training sample for instance. Using this connection <span class="math display">\[
\begin{aligned}
L(W) &amp;= \mathop{\mathrm{Tr}}((Y - WX)^T (Y - WX))\\
&amp;= \mathop{\mathrm{Tr}}(Y^TY) - \mathop{\mathrm{Tr}}(Y^TWX) - Tr(X^TW^T Y) + \mathop{\mathrm{Tr}}(X^TW^T W X)\\
&amp;= \mathop{\mathrm{Tr}}(Y^TY) - 2\mathop{\mathrm{Tr}}(Y^TWX) + \mathop{\mathrm{Tr}}(X^TW^T W X).
\end{aligned}
\]</span> If we want to compute the matrix derivative of least squares style problems then we need to be able to compute the matrix derivatives of traces of the form <span class="math inline">\(\mathop{\mathrm{Tr}}(AB)\)</span>, <span class="math inline">\(\mathop{\mathrm{Tr}}(ABC)\)</span>, <span class="math inline">\(\mathop{\mathrm{Tr}}(A^T B^T C B D)\)</span>.</p>
<div id="prp-tr1" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 3 </strong></span>For matrices <span class="math inline">\(A \in \mathbb{R}^{n \times m}\)</span>, <span class="math inline">\(B \in \mathbb{R}^{m \times n}\)</span> then <span class="math display">\[
\partial_A \mathop{\mathrm{Tr}}(AB) = B^T, \partial_B \mathop{\mathrm{Tr}}(AB) = A^T
\]</span></p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span>Each entry of AB is of the form <span class="math display">\[
[AB]_{ij} = \sum_{l=1}^m a_{il} b_{lj}.
\]</span> Thus taking the partial derivative with respect to a single element <span class="math display">\[
\left[ \partial_A \mathop{\mathrm{Tr}}(AB) \right]_{rc} = \frac{\partial}{\partial a_{rc}}\sum_{i=1}^n \sum_{l=1}^m a_{il} b_{li} =  b_{cr} = \left[ B^T\right]_{rc}
\]</span> Therefore <span class="math inline">\(\partial_A \mathop{\mathrm{Tr}}(AB) = B^T\)</span>. An identical argument gives <span class="math inline">\(\partial_B \mathop{\mathrm{Tr}}(AB) = A^T\)</span>.</p>
</div>
<p>An educated guess useful for differentiating traces of products of distinct matrices is as follows: you can treat the matrices as univariate variables and in this context differentiating removes the variable in question from the product, then you forget about the Trace and transpose the terms appropriately so that the answer has the correct dimensions. Lets see a more complicated example.</p>
<div id="prp-tr2" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 4 </strong></span>For matrices <span class="math inline">\(A \in \mathbb{R}^{n \times m}\)</span>, <span class="math inline">\(B \in \mathbb{R}^{m \times k}, C \in \mathbb{R}^{k \times n}\)</span> then <span class="math display">\[
\partial_B \mathop{\mathrm{Tr}}(ABC) = A^T C^T
\]</span></p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span>Each entry of <span class="math inline">\(ABC\)</span> is of the form <span class="math display">\[
[ABC]_{ij} = \sum_{l=1}^m \sum_{h=1}^m a_{il} b_{lh} c_{hj}.
\]</span> Thus taking the partial derivative with respect to a single element <span class="math display">\[
\left[ \partial_B \mathop{\mathrm{Tr}}(ABC) \right]_{rk} = \frac{\partial}{\partial b_{rk}}\sum_{i=1}^n \sum_{l=1}^m \sum_{h=1}^m a_{il} b_{lh} c_{hi} = \sum_{i=1}^n a_{ir} c_{ki}  = \left[ A^TC^T \right]_{rc}
\]</span> Therefore <span class="math inline">\(\partial_B \mathop{\mathrm{Tr}}(ABC) = A^TC^T\)</span>.</p>
</div>
<p>Finally, lets consider the following a tougher case where we no longer consider distinct matrices in the product, in particular given <span class="math inline">\(A \in \mathbb{R}^{m \times n}\)</span>, <span class="math inline">\(B \in \mathbb{R}^{K \times m}, C \in \mathbb{R}^{K \times K}\)</span> and <span class="math inline">\(D\in \mathbb{R}^{m \times n}\)</span> we want to compute <span class="math inline">\(\mathop{\mathrm{Tr}}(A^T B^T C B D)\)</span>. If we were to guess using our rule of thumb we might suggest that forgetting the trace and treating each matrix as a univariate variable then by analogy with the chain rule <span class="math inline">\(\partial_A\mathop{\mathrm{Tr}}(A^T B^T C B D)\)</span> might look like <span class="math inline">\(A^TCBD + A^T B^T C D\)</span>. Note <span class="math inline">\(CBD \in \mathbb{R}^{K \times n}\)</span> and <span class="math inline">\(A^T \in \mathbb{R}^{n \times m}\)</span> so as stands the first terms dimensions don’t make sense, but if we switch the groups of matrices on either side of the term we removed then the multiplication <span class="math inline">\(CBDA^T \in \mathbb{R}^{K \times m}\)</span> is consistent and matches the dimensions of <span class="math inline">\(B\)</span>. Likewise switching the order of multiplication in the second term using the same principles gives us the guess <span class="math inline">\(CBDA^T+ D A^T B^T C\)</span>.</p>
<div id="prp-tr3" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 5 </strong></span>For matrices <span class="math inline">\(A \in \mathbb{R}^{m \times n}\)</span>, <span class="math inline">\(B \in \mathbb{R}^{K \times m}, C \in \mathbb{R}^{K \times K}\)</span> and <span class="math inline">\(D\in \mathbb{R}^{m \times n}\)</span>, then <span class="math display">\[
\partial_B \mathop{\mathrm{Tr}}(A^T B^T C B D) = AD^TB^TC^T +  C^TBAD^T
\]</span></p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span>Using the shorthand <span class="math inline">\([A]_{ij} = a_{ij} = a'_{ji} = [A^T]_{ji}\)</span>, then each entry of <span class="math inline">\(A^T B^T C B D\)</span> can be written as <span class="math display">\[
[A^T B^T C B D]_{ij} = \sum_{p=1}^m \sum_{q=1}^K \sum_{e=1}^K \sum_{g=1}^m a_{ip}' b_{pq}' c_{qe} b_{eg} d_{gj}.
\]</span> Thus taking the partial derivative with respect to a single element of <span class="math inline">\(B\)</span> and using the chain rule we have <span class="math display">\[
\begin{aligned}
\left[ \partial_B \mathop{\mathrm{Tr}}(A^T B^T C B D) \right]_{rk} &amp;= \frac{\partial}{\partial b_{rk}}\sum_{i=1}^n \sum_{p=1}^m \sum_{q=1}^K \sum_{e=1}^K \sum_{g=1}^m a_{ip}' b_{pq}' c_{qe} b_{eg} d_{gi} \\
&amp;=\sum_{i=1}^n \sum_{p=1}^m \sum_{q=1}^K \sum_{e=1}^K \sum_{g=1}^m a_{ip}' \frac{\partial b_{pq}'}{\partial b_{kr}'} c_{qe} b_{eg} d_{gi} + \sum_{i=1}^n \sum_{p=1}^m \sum_{q=1}^K \sum_{e=1}^K \sum_{g=1}^m a_{ip}' b_{pq}' c_{qe} \frac{\partial b_{eg}}{\partial b_{rk}} d_{gi}\\
&amp;= \sum_{i=1}^n \sum_{e=1}^K \sum_{g=1}^m a_{ik}' c_{re} b_{eg} d_{gi} + \sum_{i=1}^n \sum_{p=1}^m \sum_{q=1}^K a_{ip}' b_{pq}' c_{qr} d_{ki}\\
&amp; = \sum_{e=1}^K \sum_{g=1}^m \sum_{i=1}^n c_{re} b_{eg} d_{gi} a_{ik}' + \sum_{q=1}^K\sum_{p=1}^m \sum_{i=1}^n  c_{rq}'b_{qp} a_{pi} d_{ik}'\\
&amp;=[CBDA^T + C^TBAD^T]_{rk}.
\end{aligned}
\]</span> Therefore <span class="math inline">\(\partial_B \mathop{\mathrm{Tr}}(A^T B^T C B D) = CBDA^T + C^TBAD^T\)</span>.</p>
</div>
<p>Lets now use the identities we have developed to compute the derivatives of a least squares loss, common in data science and machine learning applications.</p>
<div id="prp-general-loss" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 6 </strong></span>Let <span class="math inline">\(Y\in \mathbb{R}^{h \times n}\)</span>, <span class="math inline">\(X \in \mathbb{R}^{d \times n}\)</span>, <span class="math inline">\(E \in \mathbb{R}^{k \times d}\)</span> is the encoder matrix and <span class="math inline">\(D \in \mathbb{R}^{h \times k}\)</span>, if <span class="math display">\[
L= ||Y - DEX||_F^2,
\]</span> then <span class="math display">\[
\begin{aligned}
&amp;\partial_D L = 2(DEX - Y)X^TE^T,\\
&amp;\partial_E L = 2D^T(DEX - Y)X^T.
\end{aligned}
\]</span></p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span>First we rewrite <span class="math inline">\(L\)</span> in terms of a trace of a product of matrices, letting <span class="math inline">\(W=DE\)</span> then <span class="math display">\[
\begin{aligned}
L &amp;= \mathop{\mathrm{Tr}}((Y - WX)^T (Y - WX))\\
&amp;= \mathop{\mathrm{Tr}}(Y^TY) - \mathop{\mathrm{Tr}}(Y^TWX) - Tr(X^TW^T Y) + \mathop{\mathrm{Tr}}(X^TW^T W X)\\
&amp;= \mathop{\mathrm{Tr}}(Y^TY) - 2\mathop{\mathrm{Tr}}(Y^TWX) + \mathop{\mathrm{Tr}}(X^TW^T W X)\\
&amp;= \mathop{\mathrm{Tr}}(Y^TY) - 2\mathop{\mathrm{Tr}}(Y^TDEX) + \mathop{\mathrm{Tr}}(X^T E^T D^T D E X).
\end{aligned}
\]</span></p>
</div>
<p>Recall now the matrix identities <span class="math inline">\(\partial_B \mathop{\mathrm{Tr}}(ABC) = C^TA^T\)</span> and <span class="math inline">\(\partial_B \mathop{\mathrm{Tr}}(A^T B^T C B D) = CBDA^T + C^TBAD^T\)</span>. As a result taking the matrix derivative with respect to <span class="math inline">\(D\)</span> we have <span class="math display">\[
\partial_D L =  -2YX^TE^T+ DEXX^TE^T + DEXX^TE^T= 2(DEX - Y)X^TE^T
\]</span> and taking the matrix derivative with respect to <span class="math inline">\(E\)</span> gives <span class="math display">\[
\partial_E L = -2D^T Y X^T +  D^TDE X X^T +  D^TD E X X^T = 2D^T(DEX - Y)X^T.
\]</span></p>
</section>
<section id="matrix-derivarives-of-determinants" class="level3">
<h3 class="anchored" data-anchor-id="matrix-derivarives-of-determinants">Matrix derivarives of determinants</h3>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>